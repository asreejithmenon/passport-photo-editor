document.getElementById("processButton").addEventListener("click", async function (event) {
    event.preventDefault(); // Prevent default form submission

    // Show loading spinner and hide error/success messages
    document.getElementById("loadingSpinner").style.display = "block";
    document.getElementById("errorMessage").style.display = "none";
    document.getElementById("successMessage").style.display = "none";
    document.getElementById("resultContainer").style.display = "none";

    // Get the file from the input
    const fileInput = document.getElementById("fileInput");
    const file = fileInput.files[0];

    // Validate file size again (in case the user bypassed the frontend validation)
    const maxSize = 5 * 1024 * 1024; // 5 MB
    if (file.size > maxSize) {
        document.getElementById("errorMessage").innerText = "File size must be less than 5 MB.";
        document.getElementById("errorMessage").style.display = "block";
        document.getElementById("loadingSpinner").style.display = "none";
        return;
    }

    // Create a FormData object
    const formData = new FormData();
    formData.append("file", file);

    try {
        // Send the file to the server for processing
        const response = await fetch("/", {
            method: "POST",
            body: formData,
        });

        if (!response.ok) {
            const errorText = await response.text(); // Get the error message from the server
            throw new Error(`Server error: ${errorText}`);
        }

        const data = await response.json();

        if (data.status !== "success") {
            throw new Error(data.message || "An error occurred. Please try again.");
        }

        // Set the download links
        const downloadSingle = document.getElementById("downloadSingle");
        const downloadFour = document.getElementById("downloadFour");
        downloadSingle.href = data.single_photo_url;
        downloadFour.href = data.four_photos_url;

        // Fetch the single 2x2 photo for display
        const singlePhotoResponse = await fetch(data.single_photo_url);
        const singlePhotoBlob = await singlePhotoResponse.blob();
        const singlePhotoUrl = URL.createObjectURL(singlePhotoBlob);

        // Display the processed image (single 2x2 photo)
        const processedImage = document.getElementById("processedImage");
        processedImage.src = singlePhotoUrl;

        // Show the result container and success message
        document.getElementById("resultContainer").style.display = "block";
        document.getElementById("successMessage").style.display = "block";
    } catch (error) {
        console.error("Error:", error);
        // Show error message
        document.getElementById("errorMessage").innerText = error.message || "An error occurred. Please try again.";
        document.getElementById("errorMessage").style.display = "block";
    } finally {
        // Hide loading spinner
        document.getElementById("loadingSpinner").style.display = "none";
    }
});
